<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amsterdam Havenstad - CesiumJS Proof of Concept</title>
  
  <!-- Cesium SDK -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    #cesiumContainer {
      width: 100%;
      height: 100%;
    }

    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      z-index: 100;
      max-width: 300px;
      font-size: 14px;
    }

    #controls h3 {
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 16px;
      color: #333;
    }

    .control-group {
      margin-bottom: 16px;
    }

    .control-group + .control-group {
      border-top: 1px solid #eee;
      padding-top: 12px;
    }

    .control-group label {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      cursor: pointer;
      user-select: none;
    }

    .control-group input[type="checkbox"] {
      margin-right: 8px;
      cursor: pointer;
      width: 16px;
      height: 16px;
    }

    button {
      background: #0078d4;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      margin-right: 5px;
      margin-bottom: 5px;
      transition: background 0.2s;
    }

    button:hover {
      background: #106ebe;
    }

    button:active {
      background: #005a9e;
    }

    input[type="range"] {
      width: 100%;
      margin-top: 8px;
    }

    #info-panel {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 8px;
      min-width: 350px;
      max-height: 400px;
      overflow-y: auto;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      z-index: 100;
    }

    #info-panel h4 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 14px;
    }

    #entity-info {
      font-size: 13px;
      color: #666;
      line-height: 1.6;
    }

    .info-row {
      margin-bottom: 8px;
    }

    .info-label {
      font-weight: 600;
      color: #333;
    }

    .info-value {
      color: #666;
      word-break: break-word;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-top: 10px;
    }

    .status-loading {
      background: #ffe7a6;
      color: #7f5c00;
    }

    .status-success {
      background: #a6f5d7;
      color: #003d2c;
    }

    .status-error {
      background: #f5a6a6;
      color: #6b2c00;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>

  <div id="controls">
    <h3>üó∫Ô∏è Amsterdam Havenstad</h3>
    
    <div class="control-group">
      <h4 style="margin: 0 0 10px 0; font-size: 13px; color: #666;">Data Layers</h4>
      <label>
        <input type="checkbox" id="buildingLayer" checked> 
        Havengebouwen (punten)
      </label>
      <label>
        <input type="checkbox" id="quayLayer" checked> 
        Kaaigebied (polygonen)
      </label>
      <label>
        <input type="checkbox" id="routeLayer" checked> 
        Vaarroutes (lijnen)
      </label>
      <label>
        <input type="checkbox" id="structureLayer" checked> 
        3D Structuren (hoogte)
      </label>
    </div>

    <div class="control-group">
      <h4 style="margin: 0 0 10px 0; font-size: 13px; color: #666;">Cross-Section</h4>
      <button id="toggleClipping">Activeer Dwarsdoorsnede</button>
      <div style="font-size: 12px; color: #888; margin-top: 8px;">
        <label>Diepte: <span id="clippingValue">0</span>m</label>
      </div>
      <input type="range" id="clippingDepth" min="-500" max="500" value="0" disabled>
    </div>

    <div class="control-group">
      <h4 style="margin: 0 0 10px 0; font-size: 13px; color: #666;">Zoom</h4>
      <button id="zoomIn">Zoom In</button>
      <button id="zoomOut">Zoom Out</button>
    </div>

    <div class="control-group">
      <h4 style="margin: 0 0 10px 0; font-size: 13px; color: #666;">Instellingen</h4>
      <button id="resetCamera">Reset Camera</button>
      <button id="refreshData">Refresh Data</button>
    </div>

    <div id="dataStatus" class="status-badge status-loading">
      ‚è≥ Data laden...
    </div>
  </div>

  <div id="info-panel">
    <h4>‚ÑπÔ∏è Entity Informatie</h4>
    <div id="entity-info">
      <p style="color: #999;">Klik op een object op de kaart voor details</p>
    </div>
  </div>

  <script>
    // ============================================================================
    // MOCK SPARQL RESPONSE - Gestubde havenstad data
    // ============================================================================
    
    const mockSparqlResponse = {
      type: "FeatureCollection",
      features: [
        // HAVENGEBOUWEN (Punten)
        {
          type: "Feature",
          id: "building_001",
          properties: {
            name: "Amsterdam Port Authority",
            type: "administrative",
            description: "Havenautoriteit kantoor",
            year_built: 1950,
            category: "building"
          },
          geometry: {
            type: "Point",
            coordinates: [4.9076, 52.3702]
          }
        },
        {
          type: "Feature",
          id: "building_002",
          properties: {
            name: "Cargo Warehouse A",
            type: "warehouse",
            description: "Opslagloods containers",
            capacity_tons: 5000,
            category: "building"
          },
          geometry: {
            type: "Point",
            coordinates: [4.9050, 52.3680]
          }
        },
        {
          type: "Feature",
          id: "building_003",
          properties: {
            name: "Crane Station 1",
            type: "infrastructure",
            description: "Overslag kranen",
            year_built: 2015,
            category: "building"
          },
          geometry: {
            type: "Point",
            coordinates: [4.9120, 52.3710]
          }
        },

        // KAAIGEBIEDEN (Polygonen)
        {
          type: "Feature",
          id: "quay_001",
          properties: {
            name: "Kade 5",
            type: "quay",
            description: "Ligplaats voor groot schepen",
            capacity_tons: 5000,
            length_meters: 250,
            category: "quay"
          },
          geometry: {
            type: "Polygon",
            coordinates: [[
              [4.9070, 52.3695],
              [4.9090, 52.3695],
              [4.9090, 52.3705],
              [4.9070, 52.3705],
              [4.9070, 52.3695]
            ]]
          }
        },
        {
          type: "Feature",
          id: "quay_002",
          properties: {
            name: "Terminal Amsterdam",
            type: "terminal",
            description: "Containeroverslag terminal",
            capacity_tons: 10000,
            length_meters: 400,
            category: "quay"
          },
          geometry: {
            type: "Polygon",
            coordinates: [[
              [4.9010, 52.3650],
              [4.9045, 52.3650],
              [4.9045, 52.3670],
              [4.9010, 52.3670],
              [4.9010, 52.3650]
            ]]
          }
        },

        // VAARROUTES (LineStrings)
        {
          type: "Feature",
          id: "route_001",
          properties: {
            name: "Amstel-route",
            type: "water_route",
            description: "Binnenship vaarroute",
            shipping_class: "medium",
            category: "route"
          },
          geometry: {
            type: "LineString",
            coordinates: [
              [4.8950, 52.3600],
              [4.9000, 52.3620],
              [4.9050, 52.3650],
              [4.9100, 52.3700]
            ]
          }
        },
        {
          type: "Feature",
          id: "route_002",
          properties: {
            name: "IJmuiden-route",
            type: "water_route",
            description: "Zeevaart route naar zee",
            shipping_class: "large",
            category: "route"
          },
          geometry: {
            type: "LineString",
            coordinates: [
              [4.9076, 52.3702],
              [4.8900, 52.3500],
              [4.7500, 52.2800]
            ]
          }
        },

        // 3D STRUCTUREN (Polygonen met hoogte properties)
        {
          type: "Feature",
          id: "structure_001",
          properties: {
            name: "Berghallen Complex",
            type: "storage",
            description: "Opslagruimte bovenbouw",
            height_meters: 25,
            category: "structure"
          },
          geometry: {
            type: "Polygon",
            coordinates: [[
              [4.9140, 52.3720],
              [4.9160, 52.3720],
              [4.9160, 52.3735],
              [4.9140, 52.3735],
              [4.9140, 52.3720]
            ]]
          }
        }
      ]
    };

    // ============================================================================
    // CESIUM VIEWER SETUP
    // ============================================================================

    const viewer = new Cesium.Viewer('cesiumContainer', {
      baseLayerPicker: true,
      geocoder: true,
      timeline: false,
      animation: false,
      homeButton: true,
      navigationHelpButton: true
    });

    // Enable mouse wheel zoom
    viewer.scene.screenSpaceCameraController.enableZoom = true;
    viewer.scene.screenSpaceCameraController.enableRotate = true;
    viewer.scene.screenSpaceCameraController.enableTranslate = true;

    // Voeg OpenStreetMap imagery layer toe (geen terrein, geen ion token nodig)
    const osmProvider = new Cesium.OpenStreetMapImageryProvider({
      url: 'https://a.tile.openstreetmap.org/'
    });
    viewer.imageryLayers.addImageryProvider(osmProvider);

    // Zet camera op Amsterdam havenstad met goede ori√´ntatie
    viewer.camera.setView({
      destination: Cesium.Cartesian3.fromDegrees(4.9076, 52.3702, 2500),
      orientation: {
        heading: Cesium.Math.toRadians(0.0),
        pitch: Cesium.Math.toRadians(-45.0),
        roll: 0.0
      }
    });

    // ============================================================================
    // DATA LOADING
    // ============================================================================

    let dataSource = null;
    let clippingPlanesEnabled = false;

    async function loadData() {
      try {
        // Simuleer async fetch van SPARQL endpoint
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Laad GeoJSON data met basis styling
        dataSource = await Cesium.GeoJsonDataSource.load(mockSparqlResponse, {
          stroke: Cesium.Color.BLUE,
          fill: Cesium.Color.BLUE.withAlpha(0.3),
          strokeWidth: 2
        });

        viewer.dataSources.add(dataSource);

        // GEAVANCEERDE STYLING PER FEATURE TYPE
        const entities = dataSource.entities.values;
        
        for (let entity of entities) {
          if (!entity.properties) continue;
          
          const category = entity.properties.category?._value;
          const type = entity.properties.type?._value;
          const name = entity.properties.name?._value || 'Unknown';

          // HAVENGEBOUWEN (Punten)
          if (category === 'building' && entity.point) {
            entity.point.pixelSize = 10;
            entity.point.color = Cesium.Color.RED;
            entity.point.outlineColor = Cesium.Color.WHITE;
            entity.point.outlineWidth = 2;
            
            entity.label = new Cesium.LabelGraphics({
              text: name,
              fillColor: Cesium.Color.WHITE,
              backgroundColor: Cesium.Color.BLACK,
              backgroundPadding: new Cesium.Cartesian2(4, 4),
              pixelOffset: new Cesium.Cartesian2(0, -15),
              font: '11px sans-serif'
            });
          }

          // KAAIGEBIEDEN (Polygonen)
          else if (category === 'quay' && entity.polygon) {
            entity.polygon.material = new Cesium.ColorMaterialProperty(
              Cesium.Color.BLUE.withAlpha(0.4)
            );
            entity.polygon.outline = true;
            entity.polygon.outlineColor = Cesium.Color.DARKBLUE;
            entity.polygon.outlineWidth = 2;
          }

          // VAARROUTES (LineStrings)
          else if (category === 'route' && entity.polyline) {
            entity.polyline.width = 3;
            entity.polyline.material = new Cesium.PolylineGlowMaterialProperty({
              glowPower: 0.2,
              color: Cesium.Color.GREEN
            });
            entity.polyline.clampToGround = true;
          }

          // 3D STRUCTUREN (Polygonen met extrusion)
          else if (category === 'structure' && entity.polygon) {
            const height = entity.properties.height_meters?._value || 20;
            entity.polygon.material = new Cesium.ColorMaterialProperty(
              Cesium.Color.YELLOW.withAlpha(0.5)
            );
            entity.polygon.extrudedHeight = height;
            entity.polygon.outline = true;
            entity.polygon.outlineColor = Cesium.Color.ORANGE;
            entity.polygon.outlineWidth = 1;
          }

          // Voeg entity click handler toe
          entity.description = createDescription(entity.properties);
        }

        // Update status
        document.getElementById('dataStatus').innerHTML = 
          `<span class="status-badge status-success">‚úì ${entities.length} objecten geladen</span>`;
        
        // Zoom naar data
        await viewer.zoomTo(dataSource);

      } catch (error) {
        console.error('Data loading error:', error);
        document.getElementById('dataStatus').innerHTML = 
          `<span class="status-badge status-error">‚úó Fout bij laden</span>`;
      }
    }

    // ============================================================================
    // ENTITY DESCRIPTION BUILDER
    // ============================================================================

    function createDescription(properties) {
      let html = '<table style="width:100%">';
      for (let key in properties) {
        if (properties.hasOwnProperty(key) && key !== 'category') {
          let value = properties[key]._value || properties[key];
          html += `<tr><td style="font-weight:bold">${key}:</td><td>${value}</td></tr>`;
        }
      }
      html += '</table>';
      return html;
    }

    // ============================================================================
    // ENTITY SELECTION & INFO PANEL
    // ============================================================================

    const handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);

    handler.setInputAction(function onLeftClick(movement) {
      const pickedObject = viewer.scene.pick(movement.position);
      
      if (Cesium.defined(pickedObject) && pickedObject.id) {
        const entity = pickedObject.id;
        displayEntityInfo(entity);
      } else {
        clearEntityInfo();
      }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    function displayEntityInfo(entity) {
      let html = '';
      if (entity.properties) {
        for (let key in entity.properties) {
          if (entity.properties.hasOwnProperty(key)) {
            const value = entity.properties[key]._value || entity.properties[key];
            html += `<div class="info-row"><span class="info-label">${key}:</span> <span class="info-value">${value}</span></div>`;
          }
        }
      }
      document.getElementById('entity-info').innerHTML = html || 'Geen data beschikbaar';
    }

    function clearEntityInfo() {
      document.getElementById('entity-info').innerHTML = 
        '<p style="color: #999;">Klik op een object op de kaart voor details</p>';
    }

    // ============================================================================
    // LAYER VISIBILITY TOGGLES
    // ============================================================================

    function updateLayerVisibility() {
      const showBuildings = document.getElementById('buildingLayer').checked;
      const showQuays = document.getElementById('quayLayer').checked;
      const showRoutes = document.getElementById('routeLayer').checked;
      const showStructures = document.getElementById('structureLayer').checked;

      if (dataSource) {
        const entities = dataSource.entities.values;
        for (let entity of entities) {
          if (!entity.properties) continue;
          
          const category = entity.properties.category?._value;
          
          entity.show = 
            (category === 'building' && showBuildings) ||
            (category === 'quay' && showQuays) ||
            (category === 'route' && showRoutes) ||
            (category === 'structure' && showStructures);
        }
      }
    }

    document.getElementById('buildingLayer').addEventListener('change', updateLayerVisibility);
    document.getElementById('quayLayer').addEventListener('change', updateLayerVisibility);
    document.getElementById('routeLayer').addEventListener('change', updateLayerVisibility);
    document.getElementById('structureLayer').addEventListener('change', updateLayerVisibility);

    // ============================================================================
    // CLIPPING PLANES (CROSS-SECTION)
    // ============================================================================

    let clippingPlaneCollection = null;

    function initClippingPlanes() {
      clippingPlaneCollection = Cesium.ClippingPlaneCollection.fromJson({
        planes: [
          {
            normal: { x: 0.0, y: 1.0, z: 0.0 },
            distance: 0.0
          }
        ],
        enabled: false,
        edgeStyling: Cesium.ClippingPlaneEdgeStyles.Highlight
      });
      
      viewer.scene.globe.clippingPlanes = clippingPlaneCollection;
    }

    document.getElementById('toggleClipping').addEventListener('click', function() {
      if (!clippingPlaneCollection) {
        initClippingPlanes();
      }
      
      clippingPlanesEnabled = !clippingPlanesEnabled;
      clippingPlaneCollection.enabled = clippingPlanesEnabled;
      
      this.textContent = clippingPlanesEnabled ? 
        'Deactiveer Dwarsdoorsnede' : 'Activeer Dwarsdoorsnede';
      
      document.getElementById('clippingDepth').disabled = !clippingPlanesEnabled;
    });

    document.getElementById('clippingDepth').addEventListener('input', function(e) {
      if (clippingPlaneCollection && clippingPlaneCollection.enabled) {
        const depth = parseFloat(e.target.value);
        document.getElementById('clippingValue').textContent = depth;
        
        // Update clipping plane distance
        const plane = clippingPlaneCollection.get(0);
        if (plane) {
          plane.distance = depth;
        }
      }
    });

    // ============================================================================
    // CONTROL BUTTONS
    // ============================================================================

    document.getElementById('zoomIn').addEventListener('click', function() {
      const currentHeight = viewer.camera.positionCartographic.height;
      const newHeight = currentHeight * 0.5;
      viewer.camera.moveForward(currentHeight - newHeight);
    });

    document.getElementById('zoomOut').addEventListener('click', function() {
      const currentHeight = viewer.camera.positionCartographic.height;
      const newHeight = currentHeight * 2;
      viewer.camera.moveBackward(newHeight - currentHeight);
    });

    document.getElementById('resetCamera').addEventListener('click', function() {
      viewer.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(4.9076, 52.3702, 2000)
      });
    });

    document.getElementById('refreshData').addEventListener('click', function() {
      if (dataSource) {
        viewer.dataSources.remove(dataSource);
      }
      loadData();
    });

    // ============================================================================
    // INITIALIZATION
    // ============================================================================

    // Laad data bij startup
    loadData();
  </script>
</body>
</html>